<div class="container-fluid">
<div class="container">
  <h1 class="display-1 mt-2 text-center">Axon</h1>
  <p class="text-center">The <strong>Axon Test</strong> measures the raw, uncontended speed of the AI API. It evaluates the API's fundamental processing efficiency from both a "cold" (initial load) and "warm" (cached, subsequent use) state. This test focuses on the speed of signal transmission, assessing how quickly and efficiently the AI API can deliver its output when dedicated resources are available.</p>

  <div class="d-grid">
    <button class="btn btn-lg btn-primary" (click)="start()">Run Axon Test</button>
  </div>
</div>

  @if(this.axonTestSuiteExecutor.results.status !== TestStatus.Idle) {

    <table class="table text-center">
      <thead>
        <tr>
          <th></th>
          <th colspan="2">Average Token per second</th>
        </tr>
      <tr>
        <th></th>
        <th class="text-primary">Cold</th>
        <th class="text-warning">Warm</th>
      </tr>
      </thead>
      <tbody>

        @for (element of builtInAiApis; track $index) {
          <tr>
            <td class="text-start">{{ element.id }}</td>
            <td class="text-primary">0.12s</td>
            <td class="text-warning">0.05s</td>
          </tr>
        }


      </tbody>
    </table>

    @for (element of builtInAiApis; track $index) {

      <h2 class="mt-5 display-6 fs-5">{{ element.id }}</h2>
      <hr>

      <div class="d-flex">
        <!-- Retrieve all the tests for this specific API -->

        @for (test of this.getTests(getBuiltInAiAPIFromItemInterface(element)); track $index) {
          <div class="card bg-body-secondary">
            <div class="card-body">
              <div class="d-flex gap-4">
                <div class="flex-grow-1">
                  <h6 class="fs-6"><i class="bi bi-gear-wide-connected"></i> {{ test.id }}</h6>
                </div>
                <div>
                  @if(test.results.startType === "cold") {
                    <i class="bi bi-thermometer-snow text-primary"></i>
                  } @else {
                    <i class="bi bi-thermometer-sun text-warning"></i>
                  }
                </div>
                                <!-- show status here -->
                <div>
                  <axon-test-status-badge [status]="test.results.status"></axon-test-status-badge>
                  </div>

              </div>

              <table class="table table-borderless axon-test-highlights text-center mt-3">
                <thead>
                  <th></th>
                  <th>TTFT</th>
                  <th>Total Response Time</th>
                  <th>Characters/second</th>
                </thead>
                <tbody>
                  <tr>
                    <th>avg.</th>
                    <td>{{ (test.results.averageTimeToFirstToken ?? "---") | number:'1.2-2' }}</td>
                    <td>{{ (test.results.averageTotalResponseTime) ?? "---" | number:'1.2-2' }}</td>
                    <td>{{ (test.results.averageTokensPerSecond) ?? "---" | number:'1.2-2' }}</td>
                  </tr>
                  <tr>
                    <th>median.</th>
                    <td>{{ (test.results.medianTimeToFirstToken ?? "---") | number:'1.2-2'  }}</td>
                    <td>{{ (test.results.medianTotalResponseTime ?? "---") | number:'1.2-2'  }}</td>
                    <td>{{ (test.results.medianTokensPerSecond ?? "---") | number:'1.2-2'  }}</td>
                  </tr>
                </tbody>
              </table>

              @let iterationsCollapsed = viewData[test.id].iterationsCollapsed || (viewData[test.id].iterationsCollapsed === undefined && test.results.status === 'Success');

              <div class="d-flex mt-5 align-items-center">
                <small class="fs-6 flex-grow-1"><i class="bi bi-arrow-clockwise"></i> Iterations (total: {{ test.results.numberOfIterations }})</small>
                  <button class="btn bg-dark-subtle btn-sm" (click)="viewData[test.id].iterationsCollapsed === undefined? viewData[test.id].iterationsCollapsed = false : viewData[test.id].iterationsCollapsed = !viewData[test.id].iterationsCollapsed">
                    @if(iterationsCollapsed) {
                      <i class="bi bi-plus"></i> Expand iterations
                    } @else {
                      <i class="bi bi-dash"></i> Collapse iterations
                    }
                  </button>

              </div>

              <div class="card bg-dark-subtle ps-2 pt-2 mt-3">
                <strong style="font-size: 0.7rem;"><i class="bi bi-input-cursor"></i> Input</strong>
                <p class="text-secondary"><small>{{ test.results.input }}</small></p>
              </div>


              <table class="table table-borderless table-sm mt-3 axon-test-card">
                <thead class="text-center text-body-emphasis">
                  <tr>
                    <th>#</th>
                    <th>Status</th>
                    <th>TTFT (ms)</th>
                    <th>Total Response Time (ms)</th>
                    <th>Characters/second</th>
<!--                    <th>Output</th>-->
                    <!-- Todo: Find a way to show the output without breaking the UI entirely -->
                  </tr>
                </thead>

                <tbody class="table-group-divider  text-end" [class.collapse]="iterationsCollapsed">
                  @for (testIterationResult of test.results.testIterationResults; track $index) {
                    <tr>
                      <td class="text-center">{{ $index }}</td>
                      <td><axon-test-status-badge [status]="testIterationResult.status"></axon-test-status-badge></td>
                      <td>{{ testIterationResult.timeToFirstToken | number:'1.2-2' }}</td>
                      <td>{{ testIterationResult.totalResponseTime | number:'1.2-2' }}</td>
                      <td>{{ testIterationResult.tokensPerSecond | number:'1.2-2' }}</td>
<!--                      <td style="width: 50px;">{{ testIterationResult.output }} </td>-->
                      <!-- Todo: Find a way to show the output without breaking the UI entirely -->
                    </tr>
                  }
                </tbody>
              </table>

              <!-- Create another tbody and use it as a group to then say expand iterations and not just see/hide iterations -->

              <div class="d-grid mt-4">
                <button class="btn bg-dark-subtle btn-sm" (click)="viewData[test.id].iterationsCollapsed === undefined? viewData[test.id].iterationsCollapsed = false : viewData[test.id].iterationsCollapsed = !viewData[test.id].iterationsCollapsed">
                  @if(iterationsCollapsed) {
                    <i class="bi bi-chevron-right"></i> See iterations
                  } @else {
                    <i class="bi bi-chevron-up"></i> Hide iterations
                  }
                </button>
              </div>
            </div>
          </div>
        }

      </div>
    }
  }
</div>

